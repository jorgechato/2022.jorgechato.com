<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<title>
How to DESTROY your AWS services, a Platform journey Vol.1 |
jorgechato
</title>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=alternate type=application/rss+xml href=https://jorgechato.comindex.xml title=jorgechato>
<link rel=icon type=image/png href=/img/favicon.png>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="How to DESTROY your AWS services, a Platform journey Vol.1">
<meta name=twitter:description content="This is Volume 1 of a series of articles about how to deploy and automate the AWS infrastructure as code. Terraform will be the king of this experiment. From now tho, we will cover the architecture and some real life scenarios with chaos engineering.">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-146816931-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body>
<header class="header bg-header w-full text-sm flex items-center sticky top-0 z-20">
<div class="header-wrap mx-auto flex items-center flex-auto px-4 w-full max-w-extreme">
<div class="header-left mr-5 flex flex-none items-center">
<a href=/ class="header-logo inline-block leading-none godo-tracking" data-event-category=Header data-event-action=Logo data-event-label=Click data-event-non-interaction=true>
<span class="text-2xl font-bold">jorgechato</span>
</a>
</div>
<nav class="header-center mainMenu relative flex items-center pr-5 flex-grow overflow-auto lg:overflow-visible">
<ul itemscope itemtype=http://www.schema.org/SiteNavigationElement class="nav whitespace-no-wrap hidden lg:flex">
<li itemprop=name class=ml-5>
<a itemprop=url href=https://whereisjorge.today/ class="mainMenu-link godo-tracking hover:text-primary font-medium" data-event-category=Header data-event-action=Menu data-event-non-interaction=true>
Where is jorge Today?
</a>
</li>
<li itemprop=name class=ml-5>
<a itemprop=url href=/tags/hack class="mainMenu-link godo-tracking hover:text-primary font-medium" data-event-category=Header data-event-action=Menu data-event-non-interaction=true>
Hacking
</a>
</li>
<li itemprop=name class=ml-5>
<a itemprop=url href=/tags/code class="mainMenu-link godo-tracking hover:text-primary font-medium" data-event-category=Header data-event-action=Menu data-event-non-interaction=true>
Coding
</a>
</li>
<li itemprop=name class=ml-5>
<a itemprop=url href=/author/jorge-chato class="mainMenu-link godo-tracking hover:text-primary font-medium" data-event-category=Header data-event-action=Menu data-event-non-interaction=true>
About me
</a>
</li>
<li class="dropdown is-hoverable ml-5 hidden">
<a href=# class="mainMenu-link dropdown-trigger hover:text-primary font-medium">
<span>More</span><svg class="icon is-small transform rotate-90"><use xlink:href="#icon-arrow-forward"/></svg>
</a>
<div class="dropdown-menu whitespace-normal">
<div class=dropdown-content>
<div class=js-dropdown-menu></div>
<hr class=dropdown-divider>
<div class="js-social-media social-media social-media">
<a href=https://twitter.com/jorgechato title=undefined class="hover:text-twitter p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-twitter" data-fa-transform=shrink--6></em>
</a>
<a href=https://github.com/jorgechato title=undefined class="hover:text-github p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-github" data-fa-transform=shrink--6></em>
</a>
<a href=https://www.linkedin.com/in/jorgechato/ title=undefined class="hover:text-linkedin p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-linkedin" data-fa-transform=shrink--6></em>
</a>
</div>
</div>
</div>
</li>
</ul>
</nav>
<div class="header-right flex-none flex justify-end items-center u-menu-color">
<a class="js-dark-mode button is-white items-center hidden mr-2 md:flex custom-control-input" aria-label="Dark and Light Mode">
<em class="fas fa-adjust" data-fa-transform=shrink--6></em>
</a>
<a href=javascript:; aria-label="Toggle Search" class="js-modal-button hidden godo-tracking button is-white mr-2" data-target=modal-search aria-haspopup=true data-event-category=Header data-event-action=Search data-event-label=Click data-event-non-interaction=true>
<em class="fas fa-search" data-fa-transform=shrink--6></em>
</a>
<div class="js-menu-toggle menu-burger button is-white relative ml-2 lg:hidden"><span></span><span></span><span></span></div>
</div>
</div>
</header>
<div class="nav-mob fixed inset-0 pt-16 pb-5 bg-header h-screen z-10 w-full text-center lg:hidden">
<div class="nav-mob-wrap absolute inset-0 top-16 py-5 overflow-auto flex justify-between flex-col">
<div class="py-4 flex justify-center md:hidden buttons">
<a class="js-dark-mode button is-white items-center mr-2 md:flex custom-control-input" aria-label="Dark and Light Mode">
<em class="fas fa-adjust" data-fa-transform=shrink--6></em>
</a>
</div>
<div class=py-4>
<ul>
<li>
<a href=https://whereisjorge.today/ class="block px-5 py-2 font-medium text-22 leading-tight">
Where is jorge Today?
</a>
</li>
<li>
<a href=/tags/hack class="block px-5 py-2 font-medium text-22 leading-tight">
Hacking
</a>
</li>
<li>
<a href=/tags/code class="block px-5 py-2 font-medium text-22 leading-tight">
Coding
</a>
</li>
<li>
<a href=/author/jorge-chato class="block px-5 py-2 font-medium text-22 leading-tight">
About me
</a>
</li>
</ul>
</div>
<div class="js-social-media social-media nav-mob-social-media social-media is-inline py-4">
<a href=https://twitter.com/jorgechato title=undefined class="hover:text-twitter p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-twitter" data-fa-transform=shrink--6></em>
</a>
<a href=https://github.com/jorgechato title=undefined class="hover:text-github p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-github" data-fa-transform=shrink--6></em>
</a>
<a href=https://www.linkedin.com/in/jorgechato/ title=undefined class="hover:text-linkedin p-2 inline-block" target=_blank rel="noopener noreferrer">
<em class="fab fa-linkedin" data-fa-transform=shrink--6></em>
</a>
</div>
</div>
</div>
<div class="post-header px-4 mx-auto max-w-740 relative z-3 pt-8">
<div class=intro-header>
<div class=post-heading>
<div class="mb-3 text-gray-400 tracking-wider text-sm font-medium">
<a title=code href=https://jorgechato.com/tags/code/>
CODE
</a>&nbsp;
<a title=terraform href=https://jorgechato.com/tags/terraform/>
TERRAFORM
</a>&nbsp;
<a title=platform-journey href=https://jorgechato.com/tags/platform-journey/>
PLATFORM-JOURNEY
</a>&nbsp;
</div>
<h1 class="post-title text-32 md:text-4xl lg:text-44 text-title">
<span class=emoji>📦</span>
How to DESTROY your AWS services, a Platform journey Vol.1
</h1>
<div class="post-excerpt mt-6 text-22 text-gray-500">
<p>This is Volume 1 of a series of articles about how to deploy and automate the AWS infrastructure as code. Terraform will be the king of this experiment. From now tho, we will cover the architecture and some real life scenarios with chaos engineering.</p>
</div>
<div class="meta hh flex items-center relative z-4 flex-auto leading-snug overflow-hidden">
<ul class="hh-author flex flex-wrap flex-none mr-3">
<li class="hh-author-item realtive">
<span class="relative block avatar is-45x45">
<a href=https://jorgechato.com/author/jorge-chato/>
<img class="no-zoom absolute u-image block rounded-full" src="https://avatars.githubusercontent.com/u/4450555?v=4" alt="Go to the profile of Jorge Chato">
</a>
</span>
</li>
</ul>
<div class="hh-right flex-auto overflow-hidden">
<div class="hh-author-name text-sm noWrapWithEllipsis">
<a href=https://jorgechato.com/author/jorge-chato/>Jorge Chato</a>
</div>
<div class="hh-date flex items-center text-gray-500 text-sm">
23 Apr 2020
<span class="bull mx-1">·</span>
4 min read
</div>
</div>
</div>
</div>
</div>
</div>
<div class="post-wrap max-w-1100 relative mx-auto">
<div class="px-4 mx-auto max-w-740 relative" role=main>
<article class="article post-body" id=post-body>
<p>This is a series of articles about <strong>AWS</strong> automation with <strong>terraform</strong>. In this volume we will discuss the overall architecture we want to accomplish as well as some easy exercises with <a href=https://chaostoolkit.org/><strong>chaos engineering</strong></a> to test real world edge cases.</p>
<p>This <strong>chaos</strong> experiments will help us to understand the goodies and the limitations of our infrastructure.</p>
<p>First things first.</p>
<p>As a developer I want to have a solid pipeline where I only need to be worry about code and tests. After I commit my changes into a repository I get all the feedback about my code analysis and tests in a production like environment. If I did my work well the promotion to production, for instance, should be automatic (or validated by other developer).</p>
<p>Discussing the pipeline is out of scope for this series of articles but I plan to have an entire set of articles about CI/CD. Just bare with me.</p>
<figure><img src=/img/2019/09/Screenshot-2019-09-01-at-10.38.13.png>
</figure>
<p>In this scenario let&rsquo;s assume we want to work with Docker. Next up is getting our Docker image up into <strong>AWS&rsquo;s EC2 Container Registry (ECR)</strong>. While we could use Docker Hub, ECR comes with all of the usual benefits of using other AWS services with other AWS services.</p>
<p>Any time a new feature is committed to the master branch the pipeline will trigger the update and retag the latest version in <strong>ECR.</strong></p>
<p>Following with the architecture let&rsquo;s take a loot at the diagram.</p>
<figure><img src=/img/2019/09/Screenshot-2019-09-01-at-12.10.31.png>
</figure>
<p>The main core of the platform will be the ECS cluster.</p>
<p>An <strong>Amazon ECS cluster</strong> is a regional grouping of one or more container instances on which you can run task requests. It help us to deploy and handle the Docker images from the different services.</p>
<p>Even thought you can have multiple EC2 instances linked to a single ECS cluster, in this case we will only use one (money constrains).</p>
<p>The EC2 instance will hold <strong>three containers</strong>, this containers are described in the task definitions of the ECS (the technical details will be covered in Volume 2). We are going to deploy 3 services, a <strong>frontend</strong>, an <a href=https://github.com/jorgechato/api.jorgechato.com><strong>API</strong> (Golang)</a> and a <strong>reverse proxy</strong> (<a href=https://github.com/umputun/nginx-le>Nginx</a>). The reverse proxy will download, renew open certificate authorities and handle the traffic.</p>
<p>This overall view of the architecture and services is enough to start questioning some scenarios. As lazy developers we always need to thing about automation, otherwise you will be loosing time, money and let&rsquo;s be real it is not fun at all. After all in the process of automation you end up learning new technologies and techniques.</p>
<h2>Table of content</h2><nav id=TableOfContents>
<ul>
<li><a href=#lets-do-some-chaos>Let&rsquo;s do some CHAOS</a></li>
<li><a href=#a-dive-into-the-report>A dive into the report</a></li>
<li><a href=#resources>Resources</a></li>
<li><a href=#changelog>CHANGELOG</a></li>
</ul>
</nav><h2 id=lets-do-some-chaos>Let&rsquo;s do some CHAOS</h2>
<hr>
<p>In a nutshell Chaos engineering is experimenting on a software system in production in order to build confidence in the system&rsquo;s capability. It allows you to ask questions you won&rsquo;t necessarily think about while developing.</p>
<p>To replicate the following experiments you might want to install the following dependencies.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ pip install -U chaostoolkit chaostoolkit-reporting
$ brew install awscli
</code></pre></div><p>Starting with the assumption the instance is healthy. We can test the behaviour of the services.</p>
<p>In the <strong>first scenario</strong> we are going to simulate a random <strong>shutdown</strong> of one of the services. Poor implementation of the API, heavy requests, raising the service&rsquo;s memory or CPU limit&mldr; could be real-world triggers. <strong>Terminating</strong> the API service <em>should not prevent the rest of the applications from running</em>. Our architecture does not have any dependency with the API, we assume the frontend is a 3rd party service with no integration with the API.</p>
<p>Every service terminated should come back to life from our ECS cluster. Meaning the impact for the clients using our API should be minimal. As we are going to see in the next volumes of this series, we could specify multiple services of the same image. While one service could face a shutdown the rest services should be able to handle the requests properly and assure the availability of the resource.</p>
<blockquote>
<p><strong>Spoiler alert:</strong> Have a look at the reverse-proxy</p>
</blockquote>
<p>For the sake of simplicity we are going to use mainly the <strong>process</strong> provider and run <a href=https://aws.amazon.com/es/cli/>awscli</a> and ssh scripts. Interpolation might be tricky for <em>chaostoolkit</em>, for that reason we call an external bash script.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
aws ecs <span class=se>\
</span><span class=se></span>    describe-services <span class=se>\
</span><span class=se></span>    --services api blog nginx <span class=se>\
</span><span class=se></span>    --cluster <span class=nv>$CLUSTER</span> <span class=se>\
</span><span class=se></span>    --query <span class=s1>&#39;length(services[?status==`ACTIVE`])&#39;</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
ssh <span class=nv>$USER</span>@<span class=nv>$SERVER</span> <span class=se>\
</span><span class=se></span>    docker stop <span class=se>\
</span><span class=se></span>    <span class=k>$(</span>ssh <span class=nv>$USER</span>@<span class=nv>$SERVER</span> docker ps -q --filter <span class=s1>&#39;name=ecs-api-*&#39;</span> --format<span class=o>=</span><span class=s1>&#39;{{.ID}}&#39;</span><span class=k>)</span>
</code></pre></div>
<blockquote>
<p>All this experiments, as well as the final <strong><a href=https://github.com/jorgechato/platform-tf-chaos/blob/master/report.pdf>report</a></strong> is available in this <strong><a href=https://github.com/jorgechato/platform-tf-chaos>repository</a></strong>. New scenarios might be included.</p>
</blockquote>
<hr>
<h2 id=a-dive-into-the-report>A dive into the report</h2>
<p>If the reverse-proxy is terminated our services won&rsquo;t be reachable from internet although that doesn&rsquo;t prevent applications from running.</p>
<p>While the reverse-proxy is up and running, a shutdown of any service won&rsquo;t prevent applications from running neither block any request from the internet.</p>
<p>If you had a look at the <a href=https://github.com/jorgechato/platform-tf-chaos/tree/master/experiments><strong>experiments</strong></a> you probably noticed the emptiness of the <strong>rollbacks</strong> section. ECS can handle the shutdown of our services pretty fast triggering the start of a new container.</p>
<hr>
<p>Now that we understood the limits of the platform we can have a look at the implementation as code with <strong>terraform</strong>. Follow the next article of this series by searching for the <strong><a href=/tag/platform-journey/>platform-journey</a></strong> tag.</p>
<h2 id=resources>Resources</h2>
<ul>
<li><a href=https://github.com/dastergon/awesome-chaos-engineering>https://github.com/dastergon/awesome-chaos-engineering</a></li>
<li><a href=https://www.oreilly.com/ideas/chaos-engineering>https://www.oreilly.com/ideas/chaos-engineering</a></li>
<li><a href="https://principlesofchaos.org/?lang=ENcontent">https://principlesofchaos.org/?lang=ENcontent</a></li>
</ul>
<hr>
<h2 id=changelog>CHANGELOG</h2>
<ul>
<li>2019 September 18 - ADD Resources</li>
</ul>
<button onclick=topFunction() id=backtotopButton>
<em class="fa fa-angle-up"></em>
</button>
<script>document.addEventListener('scroll',function(){document.body.scrollTop>50||document.documentElement.scrollTop>50?(document.getElementById('backtotopButton').style.opacity='1',document.getElementById('backtotopButton').style.transition='0.5s'):(document.getElementById('backtotopButton').style.opacity='0',document.getElementById('backtotopButton').style.transition='0.5s')});function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script>
<div class="post-tags mb-8">
<div class=buttons>
<a class="button is-light font-medium text-sm capitalize godo-tracking" href=https://jorgechato.com/tags/code/>
code
</a>&nbsp;
<a class="button is-light font-medium text-sm capitalize godo-tracking" href=https://jorgechato.com/tags/terraform/>
terraform
</a>&nbsp;
<a class="button is-light font-medium text-sm capitalize godo-tracking" href=https://jorgechato.com/tags/platform-journey/>
platform-journey
</a>&nbsp;
</div>
</div>
</article>
<div class="prev-next pb-8">
<hr class=my-10>
<div class="flex relative godo-tracking mb-8" data-event-category=Article data-event-action="Previous article" data-event-non-interaction=true>
<div class="prev-next-body pl-6 flex-auto">
<a href=https://jorgechato.com/how-to-learn-a-new-language/>
<div class="text-sm leading-none text-gray-500 mb-2 font-medium">Previous article</div>
<h2 class="prev-next-title text-title mb-2 text-xl md:text-22">
✍️
How to Learn a New Language
</h2>
<p class="prev-next-excerpt text-base text-gray-500 lineClamp-2 leading-snug">
The language is one of many things that make us humans.
It let us to communicate each others and broadcast our ideas and thoughts.
Vocabulary is one of the key areas of every language.
</p>
</a>
</div>
</div>
<div class="flex relative godo-tracking" data-event-category=Article data-event-action="Next article" data-event-non-interaction=true>
<div class="prev-next-body pl-6 flex-auto">
<a href=https://jorgechato.com/the-power-of-dockers-micro-images-a-golang-journey-vol.1/>
<div class="text-sm leading-none text-gray-500 mb-2 font-medium">Next article</div>
<h2 class="prev-next-title text-title mb-2 text-xl md:text-22">
🐳
The power of docker's MICRO images, a Golang journey Vol.1
</h2>
<p class="prev-next-excerpt text-base text-gray-500 lineClamp-2 leading-snug">
A Golang journey is a series of articles about golang as microservice.
It is a complementary set for the platform journey series.
In this first volume we will cover the docker images and CI/CD pipeline.
</p>
</a>
</div>
</div>
</div>
</div>
</div>
<footer class="footer-light py-10 lg:pt-16 text-center lg:text-left">
<div class="mx-auto max-w-extreme px-4">
<div class="flex flex-col lg:flex-row justify-between">
<div class="footer-copy text-sm order-3 mt-8 flex-none lg:text-left lg:order-none lg:mt-0">
&copy; 2020
<a href=https://jorgechato.com>jorgechato</a>.
All rights reserved.
<div class=mt-2>
Design with <span class="icon animated infinite pulse">❤️</span>by
<a href=https://jorgechato.com/ class=link>@JorgeChato</a>.
<a href=https://github.com/jorgechato/hution>Hution</a> Theme.
</div>
</div>
<div class="js-social-media social-media footer-social-media mt-8 flex-none lg:mt-0 is-inline">
<div class="js-social-media social-media footer-social-media flex-none lg:mt-0 is-inline">
<a href=https://twitter.com/jorgechato target=_blank class="hover:text-twitter p-2 inline-block" name=twitter>
<em class="fab fa-twitter" data-fa-transform=shrink--6></em>
</a>
<a href=https://github.com/jorgechato target=_blank class="hover:text-github p-2 inline-block" name=github>
<em class="fab fa-github" data-fa-transform=shrink--6></em>
</a>
<a href=https://www.linkedin.com/in/jorgechato/ target=_blank class="hover:text-linkedin p-2 inline-block" name=linkedin>
<em class="fab fa-linkedin" data-fa-transform=shrink--6></em>
</a>
<link rel=stylesheet href=https://jorgechato.com/css/main.css>
<link rel=stylesheet href=https://jorgechato.com/css/base.css>
<link rel=stylesheet href=https://jorgechato.com/css/github.css>
<link rel=stylesheet href=https://jorgechato.com/css/zooming.css>
<script>let darkMode=localStorage.getItem("theme");darkMode==='dark'&&document.documentElement.classList.add('dark')</script>
<script src=https://jorgechato.com/js/main.js></script>
<script src=https://jorgechato.com/js/zooming.min.js></script>
<script src=https://jorgechato.com/js/fontawesome.all.min.js></script>
<script>document.addEventListener('DOMContentLoaded',function(){new Zooming({bgColor:"var(--bg)",bgOpacity:.5,scaleBase:.9}).listen('figure>img:not(.no-zoom)')})</script>
<meta name=generator content="Hugo 0.87.0">
</div>
</div>
</footer>
</body>
</html>